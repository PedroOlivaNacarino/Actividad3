---
title: "Actividad3"
author: "Pedro Oliva Nacarino"
date: "2026-01-05"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
    highlight: kate
    number_sections: true
    code_folding: show
  word_document:
    toc: true
  pdf_document:
    toc: true
editor_options:
  markdown:
    wrap: sentence
---

```{=html}

<style>
/* Importamos la fuente Roboto */
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');

/* Aplicamos Roboto y justificamos el texto */
body {
  font-family: 'Roboto', sans-serif;
  font-size: 16px;
  line-height: 1.6;
  color: #333333;
}

p {
  text-align: justify;
}

/* Damos formato al índice flotante */

#TOC {
  background-color: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 20px; /* más espacio interno 
  font-size: 16px; 
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  max-width: 320px; /* más ancho */
  line-height: 1.8;
  font-family: 'Roboto', sans-serif; 
  font-weight: 400; 
}



#TOC::before {
  content: "Índice";
  display: block;
  font-weight: 700; 
  font-size: 18px; 
  margin-bottom: 12px;
  color: #222;
  text-transform: uppercase; 
}


#TOC a {
  text-decoration: none;
  color: #007bff;
  display: block;
  padding: 5px 0;
  transition: color 0.3s ease;
}


#TOC a {
  text-decoration: none;
  color: #007bff;
  display: block;
  padding: 8px 0;
  font-weight: 500; 
  transition: all 0.3s ease;
}

#TOC a:hover {
  color: #0056b3;
  background-color: #e9ecef; 
  border-radius: 4px;
  padding-left: 10px; 
}


/* Justificamos las celdas de las tablas*/
td {
  text-align: justify;
}

/* espacio extra entre secciones*/

section {
  margin-bottom: 30px;
}


/* Estilo para pies de foto y notas al pie */
.pie-foto, .nota-pie {
  font-size: 14px;
  color: #555;
  font-style: italic;
  margin-top: 4px;
}


</style>
```

# Metodología

En la presente actividad, el objetivo es aplicar los conceptos de bioestadística y análisis multivariante a un conjunto de datos de expresión génica en 59 individuos de la población Los Simpson.
Para ello, se han seguido los siguientes pasos metodológicos: en primer lugar, se realizó la carga y limpieza del dataset, asegurando la ausencia de valores faltantes en las variables génicas seleccionadas.
A continuación, se evaluó la normalidad de cada gen mediante el test de Shapiro-Wilk, lo que permitió decidir el uso de métodos estadísticos no paramétricos.
Posteriormente, se llevó a cabo un análisis de componentes principales (PCA) para explorar la estructura de la variabilidad genética, extrayendo y visualizando los scores y la varianza explicada por los principales componentes.
Se aplicaron técnicas de agrupamiento (clustering k-means) tanto a los genes como a los individuos, y se representaron gráficamente los patrones de agrupamiento y las contribuciones de cada variable.
Además, se calcularon matrices de correlación de Spearman y se construyeron heatmaps para identificar patrones de coexpresión.
Finalmente, se elaboraron tablas descriptivas por terciles de los componentes principales y se desarrollaron modelos de regresión logística para investigar asociaciones entre la expresión génica y variables clínicas o fenotípicas.

![](images/grafico_actividad.png)

## Paso 1. Cargar la base de datos, las librerías y limpieza

Se cargan las librerías necesarias para manipulación, análisis y visualización de datos.
A continuación, se importa el archivo original con los datos completos y se crea un objeto de trabajo principal (**datos**).

Se seleccionan las variables génicas de interés y se cuantifican los valores faltantes (NA) en estas columnas.
Para garantizar la robustez del análisis, se eliminan todas las filas que presentan datos ausentes en cualquiera de los genes.
Finalmente, se verifica el tamaño del conjunto de datos limpio y se guarda una versión depurada en un nuevo archivo, que vamos a utilizar para los análisis posteriores.

```{r, warning=FALSE, message=FALSE}
# Cargar librerías necesarias
library(tidyverse)
library(pheatmap)
library(FactoMineR)
library(factoextra)
library(gtsummary)
library(flextable)
library(officer)
library(patchwork)

# Importar la base de datos
Base_de_datos_Los_Simpson_completa <- read_csv("Base de datos Los Simpson completa.csv")

# Crear objeto principal para acortar el nombre y facilitar la escritura del código
datos <- Base_de_datos_Los_Simpson_completa

# Visualizar la base de datos 
View(Base_de_datos_Los_Simpson_completa)


# Explorar estructura y resumen (lo dejo con #, activar si se prefiere explorar)
#str(datos)
#summary(datos)

# Comprobar nombres de columnas para confirmar rango de genes (lo dejo con #, activar si se prefiere explorar)
#names(datos)

# Seleccionar variables génicas (ADCY3 a UHMK1)
genes <- datos %>% select(ADCY3:UHMK1)

# Contar valores faltantes en genes
cat("Número total de valores NA en genes:", sum(is.na(genes)), "\n")

# Eliminar filas con NA en genes
datos <- datos[complete.cases(genes), ]

# Confirmar dimensiones después de limpieza
cat("Dimensiones del dataset limpio:", dim(datos), "\n")

# Guardar versión limpia
write_csv(datos, "Base_de_datos_Los_Simpson_limpia.csv")
```

## Paso 2. Test de normalidad Shapiro-Wilk para las variables génicas

Variables con distribución normal: 0 Variables sin distribución normal: 37

Ninguna de las 37 variables génicas sigue una distribución normal (todas tienen p \< 0.05).
Por este motivo para relizar el análisis descriptivo tenemos que usar la mediana y el rango intercuartílico en lugar de la media y la desviación estándar.
Para las correlaciones, usar métodos no paramétricos (Spearman).
Para PCA, esto no supone un problema porque se basa en correlaciones y escalado.

```{r}
# Aplicar el test Shapiro-Wilk a cada variable génica (ADCY3 a UHMK1)
pvalores <- sapply(datos %>% select(ADCY3:UHMK1), function(x) shapiro.test(x)$p.value)

# Convertir los resultados en un data frame ordenado
tabla_normalidad <- data.frame(
  Gen = names(pvalores),
  p_value = round(pvalores, 4)
)

# Mostrar la tabla
print(tabla_normalidad)


```

**Tabla 1.** Resultados del test de normalidad Shapiro-Wilk para cada variable, indicando el valor p y la clasificación según distribución normal o no normal.

```{r}
# Si p_value < 0.05 -> la variable NO sigue distribución normal
# Si p_value >= 0.05 -> la variable sigue distribución normal

# Contar cuántas variables son normales y cuántas no
normales <- sum(tabla_normalidad$p_value >= 0.05)
no_normales <- sum(tabla_normalidad$p_value < 0.05)

cat("Variables con distribución normal:", normales, "\n")
cat("Variables sin distribución normal:", no_normales, "\n")
```

# Resultados

## Paso 3: Análisis de componentes principales

En este bloque se realiza el análisis de componentes principales (PCA) sobre la expresión génica, asegurando previamente que no existan columnas antiguas de componentes principales en el conjunto de datos, lo que previene errores por duplicidad en ejecuciones sucesivas del script.

Se seleccionan las variables génicas y se aplica el PCA, estandarizando los datos.
Posteriormente, se extraen los scores de los componentes principales y se añaden al dataframe principal para facilitar análisis posteriores.

Para la interpretación visual de los resultados, se generan y guardan en formato PNG tres gráficos clave: el **scree plot** (Figura 1), la distribución de los individuos en el espacio de las dos primeras componentes principales (Figura 2) y la contribución de cada gen a las componentes principales (Figura 3).
Estas visualizaciones permiten identificar patrones de variabilidad y agrupamiento en la expresión génica de la muestra.

**Figura 1** muestra que la primera componente principal (Dimensión 1) explica el **12,5 %** de la varianza total, mientras que la segunda componente (Dimensión 2) aporta un **8,6 %**.
Aunque cada componente individual explica una proporción moderada, en conjunto permiten visualizar los patrones principales de variabilidad en los datos.
El resto de componentes contribuye con porcentajes menores, lo que indica que la información está distribuida entre varias dimensiones.

En **Figura 2**, la representación de los individuos en el plano definido por PC1 y PC2 revela cierta dispersión y posibles agrupamientos, lo que sugiere diferencias en perfiles de expresión génica entre subconjuntos de la muestra.
Este patrón puede estar asociado a condiciones experimentales o características biológicas específicas.

Por último, **Figura 3** indica que algunos genes presentan una alta contribución a PC1 y PC2, destacando su papel en la variabilidad global.
Las variables más alejadas del centro son las que más influyen en la separación de los individuos, lo que permite priorizar genes relevantes para análisis posteriores.

```{r, warning=FALSE, message=FALSE}

# Eliminar columnas previas de componentes principales
# si existen (si ejecutamos el script varias veces en la misma sesión de R, se pueden acumular columnas de componentes principales antiguas y nuevas, lo que puede causar errores o confusión.)

datos <- datos %>% select(-matches("^PC[0-9]+$"))

# Realizar el PCA con las variables génicas
pca <- PCA(datos %>% select(ADCY3:UHMK1), scale.unit = TRUE, graph = FALSE)

# Extraer los scores de los componentes principales
scores <- as.data.frame(pca$ind$coord)
colnames(scores) <- paste0("PC", seq_len(ncol(scores)))

# Añadir los scores al dataframe principal
datos <- cbind(datos, scores)



```

```{r, warning=FALSE, message=FALSE}
# Visualización: Scree plot (varianza explicada)
grafico_eig <- fviz_eig(pca, addlabels = TRUE, ylim = c(0, 50))
ggsave("scree_plot.png", plot = grafico_eig, width = 8, height = 6, dpi = 300, units = "in")

grafico_eig
```

**Figura 1.** Scree plot del análisis de componentes principales (PCA), mostrando la proporción de varianza explicada por cada componente.

```{r, warning=FALSE, message=FALSE}

# Visualización de individuos en las dos primeras componentes
grafico_ind <- fviz_pca_ind(pca, repel = TRUE)
ggsave("pca_individuos.png", plot = grafico_ind, width = 8, height = 6, dpi = 300, units = "in")

grafico_ind
```

**Figura 2.** Gráfico de individuos en el espacio definido por los dos primeros componentes principales (PC1 y PC2), indicando agrupamientos y dispersión.

```{r, warning=FALSE, message=FALSE}
# Visualización de variables (genes)
grafico_var <- fviz_pca_var(pca, col.var = "cos2")
ggsave("pca_variables.png", plot = grafico_var, width = 8, height = 6, dpi = 300, units = "in")

grafico_var
```

**Figura 3.** Gráfico de variables del PCA, representando la correlación de cada variable con los componentes principales y su contribución al modelo.

### Tabla PCA componentes y R2

Este bloque extrae la varianza explicada por cada componente principal tras realizar el PCA.
Se convierte la matriz de eigenvalores (pca\$eig) en un *data frame* y se renombran las columnas para mayor claridad: eigenvalor, porcentaje de varianza explicada y porcentaje acumulado.
Se añade una columna identificando cada componente principal (PC1, PC2, etc.).
Finalmente, se seleccionan y muestran en pantalla los porcentajes de varianza explicada por cada componente, lo que permite identificar cuánta información aporta cada uno al modelo y facilita la interpretación de los resultados del análisis multivariante.

```{r}

# Extraer la varianza explicada por cada componente
pca_var <- as.data.frame(pca$eig)
colnames(pca_var) <- c("Eigenvalue", "Porcentaje_varianza", "Porcentaje_acumulado")
pca_var$Componente <- paste0("PC", seq_len(nrow(pca_var)))
tabla_R2 <- pca_var[, c("Componente", "Porcentaje_varianza")]
print(tabla_R2)

```

**Tabla 2.** Contribución porcentual de cada componente principal a la varianza total.

### Tabla PCA cargas

Este bloque extrae las cargas (coordenadas) de cada gen en los componentes principales obtenidos tras el PCA.
Primero, convierte la matriz de coordenadas en un data frame y añade una columna con el nombre de cada gen. Luego, selecciona únicamente las columnas correspondientes a los dos primeros componentes principales (PC1 y PC2), facilitando así la interpretación de la contribución de cada gen a estos ejes.
Finalmente, la tabla resultante se visualiza en consola y se exporta en formato Word, permitiendo su inclusión directa en informes o presentaciones.

```{r}

# Extraer las cargas (coordenadas) de los genes en los componentes principales
tabla_cargas <- as.data.frame(pca$var$coord)
tabla_cargas$Variable <- rownames(tabla_cargas)

# Selecciona solo las columnas de los dos primeros componentes
tabla_cargas_final <- tabla_cargas[, c("Variable", "Dim.1", "Dim.2")]
colnames(tabla_cargas_final) <- c("Variable", "PC1", "PC2")

# Visualizar la tabla en consola
print(tabla_cargas_final)

# Exportar la tabla de cargas a Word
flextable(tabla_cargas_final) %>%
  save_as_docx(path = "tabla_cargas_PCA.docx")

```

**Tabla 3.** Cargas factoriales de las variables en los dos primeros componentes principales, destacando aquellas con mayor influencia en PC1 y PC2.

## Paso 4: Visualizaciones avanzadas y clustering.

Se analizan los patrones de agrupamiento tanto de genes como de individuos en el espacio definido por los dos primeros componentes principales (PC1 y PC2).
Se aplica el algoritmo k-means para realizar el clustering de los genes, identificando tres grupos diferenciados según su perfil de expresión.
Esta visualización permite observar la distribución de los genes en el espacio PCA y su contribución relativa a cada componente principal.

La secuencia de gráficas de visualización sigue una lógica analítica que permite descomponer y comprender la complejidad de los datos de expresión génica y su relación con características clínicas.
En primer lugar, el mapa PCA de los genes coloreados por clústeres (Figura 4) facilita la identificación de grupos de genes con perfiles de expresión similares, destacando aquellos que más contribuyen a la variabilidad global.
Esta visualización es clave para detectar patrones genéticos relevantes y posibles biomarcadores.
A continuación, la representación de los individuos en el espacio PCA según la categoría de IMC (Figura 5) permite explorar si existen tendencias de agrupamiento fenotípico en función del perfil genético, lo que ayuda a interpretar la relación entre la variabilidad genética y el fenotipo clínico.
Finalmente, el clustering de individuos (Figuras 6 y 7) aporta una visión complementaria al identificar subgrupos con características genéticas y clínicas diferenciadas, lo que refuerza la idea de heterogeneidad dentro de la muestra.
En conjunto, estas visualizaciones permiten describir la estructura interna de los datos y también generar hipótesis sobre la asociación entre perfiles genéticos y fenotípicos.

A continuación se realiza una descripción de cada una de las figuras realizadas en la visualización:

Figura 4.
Mapa PCA con los genes coloreados según los tres clústeres obtenidos mediante k-means.
Se aprecia que los grupos presentan posiciones claramente diferenciadas, lo que indica perfiles de expresión distintos.
Los genes más alejados del centro son los que más contribuyen a la variabilidad global.

Adicionalmente, se categoriza el IMC de los individuos en tres grupos (normal, sobrepeso y obesidad) y se visualizan en el espacio PCA coloreados según esta clasificación (Figura 5), lo que facilita la interpretación de posibles relaciones entre los perfiles genéticos y fenotípicos.

Figura 5.
Distribución de los individuos en el espacio PCA (PC1 y PC2), coloreados según la categoría de IMC.
Se observa cierta tendencia a la separación entre individuos con obesidad frente a los de IMC normal, aunque existe solapamiento, lo que sugiere heterogeneidad en los perfiles genéticos.
Finalmente, se aplica clustering a los individuos, identificando subgrupos con características genéticas y clínicas diferenciadas.

Figura 6.
Clústeres de individuos en el plano PC1-PC2, obtenidos mediante k-means.
Se identifican agrupamientos que podrían corresponder a patrones biológicos relevantes, aportando información sobre la heterogeneidad de la muestra y posibles asociaciones con fenotipos clínicos.

Figura 7.
Agrupamiento de individuos en el plano PCA, mostrando los clústeres identificados mediante k-means y su posible relación con características genéticas y clínicas.
Estos agrupamientos aportan información adicional sobre la estructura interna de la muestra y posibles correlaciones con variables fenotípicas.

```{r, warning=FALSE, message=FALSE}

# --- Clustering de variables (genes) en el espacio PCA 

# Definir coordenadas de las variables (genes) en las dos primeras dimensiones
var_coord <- pca$var$coord[, 1:2]

# Aplicar clustering k-means a los genes
set.seed(3)
clust_var <- kmeans(var_coord, centers = 3, nstart = 25)

# Visualización del clustering de genes
grafico_cluster_genes <- fviz_cluster(list(data = var_coord, cluster = clust_var$cluster),
                                      geom = "point",
                                      main = "Clustering de genes en el espacio PCA")
# Exportar en PNG
ggsave("clustering_genes.png", plot = grafico_cluster_genes, width = 8, height = 6, dpi = 300, units = "in")

grafico_cluster_genes


```

**Figura 4.** Mapa PCA con clustering de variables (genes).
Representa las variables proyectadas en el espacio definido por los dos primeros componentes principales (PC1 y PC2).
Los grupos se indican mediante colores y elipses que reflejan la proximidad y similitud entre genes.

```{r, warning=FALSE, message=FALSE}
# --- Visualización de contribuciones de los genes a PC1 y PC2 ---
grafico_contrib_PC1 <- fviz_contrib(pca, choice = "var", axes = 1, top = 15) + ggtitle("Contribución a PC1")
ggsave("contrib_PC1.png", plot = grafico_contrib_PC1, width = 8, height = 6, dpi = 300, units = "in")

grafico_contrib_PC2 <- fviz_contrib(pca, choice = "var", axes = 2, top = 15) + ggtitle("Contribución a PC2")
ggsave("contrib_PC2.png", plot = grafico_contrib_PC2, width = 8, height = 6, dpi = 300, units = "in")


# Gráfico compuesto con patchwork
grafico_patchwork <- grafico_contrib_PC1 + grafico_contrib_PC2 +
  plot_layout(ncol = 2) +
  plot_annotation(title = "Contribución de los genes a PC1 y PC2")

# Guardar el gráfico compuesto
ggsave("contribuciones_patchwork.png", plot = grafico_patchwork, width = 16, height = 6, dpi = 300, units = "in")

# Mostrar en pantalla
grafico_patchwork

```

**Figura 5.** Gráficos de contribución de variables para PC1 (A) y PC2 (B).
Identificación de los genes que más aportan a la variabilidad total del modelo.
Se presentan los 15 genes con mayor peso estadístico en cada eje.
Las variables por encima de la línea roja son las que definen la estructura de los datos en el análisis de componentes principales.

```{r, warning=FALSE, message=FALSE}

# --- Creación de variable categórica de IMC ---
datos <- datos %>%
  mutate(IMC_cat = case_when(
    imc_kg_m2 < 25 ~ "Normal",
    imc_kg_m2 >= 25 & imc_kg_m2 < 30 ~ "Sobrepeso",
    imc_kg_m2 >= 30 ~ "Obesidad"
  ))
# --- Visualización de individuos coloreados por categoría de IMC ---
grafico_ind_IMC <- fviz_pca_ind(pca,
                                geom.ind = "point",
                                col.ind = datos$IMC_cat,
                                palette = c("Normal" = "#00AFBB", "Sobrepeso" = "#E7B800", "Obesidad" = "#FC4E07"),
                                addEllipses = TRUE,
                                legend.title = "IMC",
                                title = "Individuos en el espacio PCA coloreados por IMC")
ggsave("individuos_IMC.png", plot = grafico_ind_IMC, width = 8, height = 6, dpi = 300, units = "in")

grafico_ind_IMC
```

**Figura 6.** Representación de los individuos en el espacio PCA (PC1 y PC2), coloreados según la categoría de IMC (normal, sobrepeso y obesidad).

```{r, warning=FALSE, message=FALSE}
# --- Clustering de individuos en el espacio PCA ---
ind_coord <- pca$ind$coord[, 1:2]
set.seed(3)
clust_ind <- kmeans(ind_coord, centers = 3, nstart = 25)

grafico_cluster_ind <- fviz_cluster(list(data = ind_coord, cluster = clust_ind$cluster),
                                    geom = "point",
                                    main = "Clustering de individuos en el espacio PCA")
ggsave("clustering_individuos.png", plot = grafico_cluster_ind, width = 8, height = 6, dpi = 300, units = "in")

grafico_cluster_ind
```

**Figura 7.**Agrupamiento de individuos en el plano PCA, mostrando los clústeres identificados mediante k-means y su posible relación con características genéticas y clínicas.

## Paso 5: Heatmap de correlaciones

Se calcula la matriz de correlaciones de Spearman entre la expresión de los genes y los componentes principales obtenidos por PCA.
Primero, se seleccionan únicamente las columnas numéricas correspondientes a los genes y a los componentes principales.
Se calcula la matriz de correlaciones utilizando el método de Spearman, adecuado para variables que no siguen una distribución normal.

Para asegurar la calidad de la visualización, se eliminan filas y columnas con valores no finitos (NA, NaN o Inf).
Si la matriz resultante contiene suficientes datos, se genera un heatmap que permite identificar visualmente asociaciones específicas entre genes y componentes principales, facilitando la interpretación de patrones de coexpresión y relaciones biológicas relevantes.
Si no hay suficientes datos válidos, se informa al usuario.

```{r}

genes <- datos %>% select(ADCY3:UHMK1) %>% select(where(is.numeric))
pcs <- datos %>% select(matches("^PC[0-9]+$"))  # Solo PC1, PC2, etc.
cor_matrix <- cor(genes, pcs, method = "spearman")
cor_matrix <- cor_matrix[
  apply(cor_matrix, 1, function(x) all(is.finite(x))),
  apply(cor_matrix, 2, function(x) all(is.finite(x)))
]

pheatmap(
  cor_matrix,
  main = "Correlaciones de Spearman entre genes y componentes principales",
  color = colorRampPalette(c("navy", "white", "firebrick3"))(50),
  fontsize_row = 8,
  fontsize_col = 10
)

# Guardar como PNG
pheatmap(
  cor_matrix,
  main = "Correlaciones de Spearman entre genes y componentes principales",
  color = colorRampPalette(c("navy", "white", "firebrick3"))(50),
  fontsize_row = 8,
  fontsize_col = 10,
  filename = "heatmap_correlaciones.png",
  width = 8, height = 6
)
```

**Figura 8.** Heatmap de expresión génica normalizada.
Las filas corresponden a genes y las columnas a individuos.
Se emplea una escala de colores para representar los niveles relativos de expresión, donde los tonos más intensos indican valores extremos.
Se incluyen dendrogramas que muestran el agrupamiento jerárquico tanto de genes como de individuos para identificar patrones de coexpresión y posibles asociaciones con características fenotípicas.

```{r}
# Guardar como PNG
pheatmap(
  cor_matrix,
  main = "Correlaciones de Spearman entre genes y componentes principales",
  color = colorRampPalette(c("navy", "white", "firebrick3"))(50),
  fontsize_row = 8,
  fontsize_col = 10,
  filename = "heatmap_correlaciones.png",
  width = 8, height = 6
)
```

## Paso 6 - Tabla descriptiva por terciles de PC1, PC2 y PC3

Se categorizan los valores de los tres primeros componentes principales (PC1, PC2 y PC3) en terciles, dividiendo la distribución de cada componente en tres grupos de igual tamaño: bajo (T1), medio (T2) y alto (T3).
Esta transformación facilita la comparación de características clínicas y genéticas entre grupos y permite realizar análisis descriptivos y modelos estadísticos ajustados por niveles de expresión, en lugar de valores continuos.

```{r}


# 1. Crear terciles para PC1, PC2 y PC3 
datos <- datos %>%
  mutate(
    PC1_t = cut(PC1, breaks = quantile(PC1, probs = c(0, 1/3, 2/3, 1)), include.lowest = TRUE, labels = c("T1", "T2", "T3")),
    PC2_t = cut(PC2, breaks = quantile(PC2, probs = c(0, 1/3, 2/3, 1)), include.lowest = TRUE, labels = c("T1", "T2", "T3")),
    PC3_t = cut(PC3, breaks = quantile(PC3, probs = c(0, 1/3, 2/3, 1)), include.lowest = TRUE, labels = c("T1", "T2", "T3"))
  )


```

### Tabla descriptiva por terciles de PC1:

```{r, warning=FALSE, message=FALSE}
# 2. Tabla descriptiva por terciles de PC1
tabla_desc_PC1 <- datos %>%
  select(PC1_t, imc_kg_m2, edad_anios, ADCY3:UHMK1) %>%
  tbl_summary(
    by = PC1_t,
    statistic = all_continuous() ~ "{median} [{p25}, {p75}]",
    digits = all_continuous() ~ 2
  ) %>%
  add_p(test = all_continuous() ~ "kruskal.test") %>%
  bold_labels()


# 3. Exportar la tabla a Word
as_flex_table(tabla_desc_PC1) %>%
  save_as_docx(path = "tabla_descriptiva_PC1.docx")


tabla_desc_PC1 %>% as_gt()

```

### Tabla descriptiva por terciles de PC2:

```{r, warning=FALSE, message=FALSE}

tabla_desc_PC2 <- datos %>%
  select(PC2_t, imc_kg_m2, edad_anios, ADCY3:UHMK1) %>%
  tbl_summary(
    by = PC2_t,
    statistic = all_continuous() ~ "{median} [{p25}, {p75}]",
    digits = all_continuous() ~ 2
  ) %>%
  add_p(test = all_continuous() ~ "kruskal.test") %>%
  bold_labels()

# Exportar a Word
as_flex_table(tabla_desc_PC2) %>%
  save_as_docx(path = "tabla_descriptiva_PC2.docx")

tabla_desc_PC2 %>% as_gt()

```

### Tabla descriptiva por terciles de PC3:

```{r, warning=FALSE, message=FALSE}

tabla_desc_PC3 <- datos %>%
  select(PC3_t, imc_kg_m2, edad_anios, ADCY3:UHMK1) %>%
  tbl_summary(
    by = PC3_t,
    statistic = all_continuous() ~ "{median} [{p25}, {p75}]",
    digits = all_continuous() ~ 2
  ) %>%
  add_p(test = all_continuous() ~ "kruskal.test") %>%
  bold_labels()

# Exportar a Word
as_flex_table(tabla_desc_PC3) %>%
  save_as_docx(path = "tabla_descriptiva_PC3.docx")

tabla_desc_PC3 %>% as_gt()
```

## Paso 7.Regresión logística.
El modelo de regresión logística evaluó la asociación entre los terciles de los tres primeros componentes principales (PC1_t, PC2_t, PC3_t), la edad y el sexo, con la presencia de obesidad (IMC ≥ 30) como variable dependiente.

Ninguno de los terciles de los componentes principales mostró una asociación estadísticamente significativa con la obesidad (todos los valores p > 0,05). Por ejemplo, el tercil más alto de PC1 (T3) presentó un OR de 3,36 (IC 95%: 0,46–35,8; p = 0,3), lo que indica una tendencia no significativa hacia un mayor riesgo de obesidad en este grupo, pero con un intervalo de confianza muy amplio.
Para PC2 y PC3, tampoco se observaron asociaciones significativas. Los OR para los diferentes terciles oscilaron alrededor de 1, con intervalos de confianza amplios y valores p elevados.
La edad mostró un OR de 1,02 (IC 95%: 0,97–1,07; p = 0,4), lo que sugiere que, en este modelo, la edad no se asoció significativamente con la obesidad.
El sexo masculino presentó un OR de 1,28 (IC 95%: 0,07–21,0; p = 0,9) en comparación con el femenino, sin alcanzar significación estadística.
```{r}

# Crear variable binaria de obesidad (1 = obesidad, 0 = no obesidad)
datos$obesidad <- ifelse(datos$imc_kg_m2 >= 30, 1, 0)

# Modelo de regresión logística con obesidad como variable dependiente
modelo_logistico <- glm(obesidad ~ PC1_t + PC2_t + PC3_t + edad_anios + sexo, 
                       data = datos, 
                       family = binomial)

# Tabla de resultados con odds ratio, IC 95% y p-valor
library(gtsummary)
tbl_regression(modelo_logistico, exponentiate = TRUE)


tbl_regression(modelo_logistico, exponentiate = TRUE) %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = "tabla_regresion_logistica_obesidad.docx")



```

# Interpretación
El análisis de componentes principales (PCA) realizado sobre la expresión de 37 genes en 59 individuos permitió identificar que los seis primeros componentes explican la mayor parte de la variabilidad génica (PC1: 12,5%, PC2: 8,6%, PC3: 6,5%). El scree plot evidenció que los dos primeros componentes principales explican conjuntamente el 21,1% de la varianza total, con una disminución notable a partir del tercer componente. Por este motivo, la interpretación se centró principalmente en PC1 y PC2.
La representación de los individuos en el espacio PCA mostró la existencia de agrupaciones fenotípicas, y el análisis de clustering permitió identificar tres subgrupos diferenciados tanto a nivel de genes como de individuos. Sin embargo, las tablas descriptivas por terciles de PC1, PC2 y PC3 indican que las variables clínicas como el IMC y la edad no presentan diferencias significativas entre los grupos (p > 0,05 en la mayoría de los casos). Esto sugiere que los patrones de expresión génica capturados por los componentes principales no se asocian de forma clara con estas variables clínicas en la muestra analizada.
No obstante, algunos genes sí mostraron diferencias significativas entre terciles de componentes, destacando especialmente MC4R y TMEM18 en PC2 y PC3 (p < 0,05). MC4R es un gen clave en la regulación del apetito y el metabolismo energético, asociado a la susceptibilidad a la obesidad. TMEM18, por su parte, está implicado en la regulación del peso corporal y la adiposidad, y se ha relacionado con el índice de masa corporal (IMC) y el riesgo de obesidad. La expresión diferencial de estos genes sugiere que los patrones genéticos identificados por el PCA pueden estar relacionados con diferencias en el control del peso corporal y el metabolismo entre los grupos analizados.
Además, otros genes como CADM2, KSR2, NTRK2, FTO, SH2B1, PHIP, ROBO1 y CREBRF también presentaron diferencias significativas en algunos componentes principales. FTO y SH2B1 están relacionados con el metabolismo energético y la susceptibilidad a la obesidad; KSR2 y NTRK2 participan en la regulación metabólica y la señalización neuronal del apetito; mientras que CADM2, PHIP, ROBO1 y CREBRF pueden estar implicados en la regulación metabólica y la predisposición a enfermedades metabólicas. Estos hallazgos refuerzan la importancia de la genética en la caracterización de fenotipos metabólicos y la susceptibilidad a la obesidad, y sugieren que la variabilidad en la expresión de estos genes puede tener implicaciones clínicas relevantes para la medicina personalizada y la prevención de enfermedades metabólicas.
El heatmap de correlaciones de Spearman entre la expresión de los genes y los componentes principales del PCA aporta información clave sobre los patrones genéticos subyacentes en la variabilidad de la muestra. Destaca especialmente PCSK1, que muestra una correlación positiva muy intensa con el primer componente principal (PC1), lo que sugiere que su expresión es uno de los principales motores de la variabilidad genética/metabólica en la cohorte analizada. Dado que PCSK1 participa en el procesamiento de hormonas implicadas en el metabolismo energético y la regulación del apetito, su relevancia en PC1 refuerza su papel potencial como biomarcador de riesgo metabólico.
Por otro lado, genes como ROBO1, NTRK2, KSR2 y CADM2 presentan correlaciones negativas marcadas (azul intenso) con otros componentes principales, especialmente PC2 y PC3. Estas asociaciones negativas indican que estos genes contribuyen a la diferenciación de subgrupos genéticos con perfiles metabólicos o de susceptibilidad distintos. En particular, la implicación de genes relacionados con la señalización neuronal y la regulación del metabolismo sugiere que los distintos ejes genéticos identificados por el PCA reflejan mecanismos biológicos complementarios.

Finalmente, la regresión logística realizada para evaluar la asociación entre los terciles de los componentes principales, la edad y el sexo con la presencia de obesidad no mostró asociaciones estadísticamente significativas. Ninguno de los terciles de PC1, PC2 o PC3, ni la edad ni el sexo, se asociaron de forma significativa con la obesidad en la muestra analizada (todos los valores p > 0,05). Los intervalos de confianza amplios y la ausencia de significación estadística sugieren que, en este conjunto de datos, la variabilidad genética capturada por los componentes principales no se traduce en diferencias claras en el riesgo de obesidad, aunque no se descarta que el tamaño muestral limitado pueda influir en estos resultados.
En resumen, aunque se identificaron patrones genéticos diferenciados y algunos genes concretos mostraron asociaciones relevantes con los componentes principales, estos patrones no se reflejaron en diferencias significativas en la presencia de obesidad al ajustar por edad y sexo. Estos resultados subrayan la complejidad de la relación entre la expresión génica y los fenotipos metabólicos, y la necesidad de estudios con mayor tamaño muestral para confirmar estos hallazgos.
